FROM amazonlinux:2023

# Install dependencies
RUN dnf install -y \
    nodejs \
    gcc \
    gcc-c++ \
    cmake \
    git \
    unzip \
    tar \
    xz \
    openssl-devel \
    clang \
    && dnf clean all

# Install protoc (ARM64 version)
RUN curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v3.20.3/protoc-3.20.3-linux-aarch_64.zip \
    && unzip protoc-3.20.3-linux-aarch_64.zip -d /usr/local \
    && rm protoc-3.20.3-linux-aarch_64.zip

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

WORKDIR /app

# Copy the repository
COPY . /app/valkey-glide

# Create test directories
RUN mkdir -p /app/test-npm /app/test-local

# Create test scripts
COPY reproduce-jitter/index.mjs /app/test-npm/index.mjs
COPY reproduce-jitter/index.mjs /app/test-local/index.mjs
COPY reproduce-jitter/run.sh /app/test-npm/run.sh
COPY reproduce-jitter/run.sh /app/test-local/run.sh
RUN chmod +x /app/test-npm/run.sh /app/test-local/run.sh

# Build local version from PR branch
WORKDIR /app/valkey-glide/node
RUN npm install
WORKDIR /app/valkey-glide/node/rust-client
RUN npm install
WORKDIR /app/valkey-glide/node
ENV BUILD_MODE=release
RUN npm run prereq
RUN npm run build-protobuf
WORKDIR /app/valkey-glide/node/rust-client
# Use napi build for release
RUN npm run build:release
WORKDIR /app/valkey-glide/node
RUN npm run build:ts

# Setup test directories
WORKDIR /app/test-npm
RUN npm init -y && npm install @valkey/valkey-glide

WORKDIR /app/test-local
RUN npm init -y && npm install /app/valkey-glide/node

WORKDIR /app

COPY reproduce-jitter/compare.sh /app/compare.sh
RUN chmod +x /app/compare.sh

CMD ["/app/compare.sh"]
