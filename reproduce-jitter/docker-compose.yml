services:
  valkey:
    image: valkey/valkey:8.1
    container_name: valkey-tls
    ports:
      - "6380:6379"
    volumes:
      - ./certs:/certs:ro
    command: >
      valkey-server
      --tls-port 6379
      --port 0
      --tls-cert-file /certs/server.crt
      --tls-key-file /certs/server.key
      --tls-ca-cert-file /certs/ca.crt
      --tls-auth-clients no
    healthcheck:
      test: ["CMD", "valkey-cli", "--tls", "--cert", "/certs/server.crt", "--key", "/certs/server.key", "--cacert", "/certs/ca.crt", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - glide-test

  test-runner:
    build:
      context: ..
      dockerfile: reproduce-jitter/Dockerfile.test
    container_name: glide-test-runner
    depends_on:
      valkey:
        condition: service_healthy
    environment:
      - VALKEY_HOST=valkey
      - VALKEY_PORT=6379
      - CA_CERT_PATH=/certs/ca.crt
    networks:
      - glide-test
    volumes:
      - ./certs:/certs:ro

networks:
  glide-test:
    driver: bridge
