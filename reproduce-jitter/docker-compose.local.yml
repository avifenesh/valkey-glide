services:
  valkey:
    image: valkey/valkey:8.1
    container_name: valkey-tls-local
    ports:
      - "6380:6379"
    volumes:
      - ./certs:/certs:ro
    command: >
      valkey-server
      --tls-port 6379
      --port 0
      --tls-cert-file /certs/server.crt
      --tls-key-file /certs/server.key
      --tls-ca-cert-file /certs/ca.crt
      --tls-auth-clients no
    healthcheck:
      test: ["CMD", "valkey-cli", "--tls", "--cert", "/certs/server.crt", "--key", "/certs/server.key", "--cacert", "/certs/ca.crt", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - glide-local

  test-runner:
    image: glide-jitter-issue
    container_name: glide-test-local
    depends_on:
      valkey:
        condition: service_healthy
    environment:
      - VALKEY_HOST=valkey
      - VALKEY_PORT=6379
    volumes:
      - ./certs:/certs:ro
      - ./test-local.sh:/app/test-local.sh:ro
    networks:
      - glide-local
    command: ["bash", "/app/test-local.sh"]

networks:
  glide-local:
    driver: bridge
